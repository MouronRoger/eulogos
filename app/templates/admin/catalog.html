<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog Management - Eulogos Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.4" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/alpinejs@3.13.0" crossorigin="anonymous" defer></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-800 text-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Eulogos Admin</h1>
                <nav class="flex space-x-3">
                    <a href="/" class="px-3 py-1 bg-blue-700 rounded hover:bg-blue-600 text-sm">
                        Browse Texts
                    </a>
                    <a href="/api/browse" class="px-3 py-1 bg-blue-700 rounded hover:bg-blue-600 text-sm">
                        Author Page
                    </a>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                <div class="bg-white shadow rounded-lg overflow-hidden" x-data="{ inProgress: false, message: '', percentage: 0, error: false }">
                    <div class="px-6 py-5 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800">Catalog Management</h2>
                        <p class="mt-1 text-sm text-gray-600">
                            Manage the integrated catalog that powers the entire Eulogos system.
                        </p>
                    </div>

                    <div class="p-6">
                        <h3 class="text-lg font-medium text-gray-800">Rebuild Catalog</h3>
                        <p class="mt-1 text-sm text-gray-600">
                            If you've added new texts or made changes to existing XML files, you need to rebuild
                            the catalog to reflect these changes. This process scans all XML files in the data directory,
                            extracts metadata, and rebuilds the integrated catalog.
                        </p>

                        <div class="mt-4">
                            <button
                                id="rebuild-btn"
                                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                x-bind:disabled="inProgress"
                                x-on:click="startRebuild()"
                            >
                                <span x-show="!inProgress">Rebuild Catalog</span>
                                <span x-show="inProgress">Rebuilding...</span>
                            </button>
                        </div>

                        <div class="mt-4" x-show="inProgress || message !== ''">
                            <div class="p-4 rounded"
                                 x-bind:class="error ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'">
                                <div x-show="inProgress" class="flex items-center">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span x-text="message"></span>
                                </div>
                                <div x-show="!inProgress" x-text="message"></div>
                            </div>

                            <div class="mt-2" x-show="inProgress">
                                <div class="bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" x-bind:style="'width: ' + percentage + '%'"></div>
                                </div>
                                <p class="mt-1 text-xs text-gray-500 text-right" x-text="percentage + '%'"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <p class="text-center text-sm text-gray-500">
                    Eulogos Admin &copy; 2025
                </p>
            </div>
        </footer>
    </div>

    <script>
        function startRebuild() {
            const app = Alpine.evaluate(document.querySelector('[x-data]')).__x.$data;
            app.inProgress = true;
            app.message = "Starting catalog rebuild...";
            app.percentage = 0;
            app.error = false;

            fetch('/admin/rebuild-catalog', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Start polling for status updates
                pollStatus();
            })
            .catch(error => {
                app.inProgress = false;
                app.message = "Error starting rebuild: " + error.message;
                app.error = true;
            });
        }

        function pollStatus() {
            const app = Alpine.evaluate(document.querySelector('[x-data]')).__x.$data;

            const checkStatus = () => {
                fetch('/admin/rebuild-status')
                .then(response => response.json())
                .then(data => {
                    app.message = data.message;
                    app.percentage = data.percentage;
                    app.error = data.error || false;

                    if (data.in_progress) {
                        // Continue polling
                        setTimeout(checkStatus, 1000);
                    } else {
                        // Finished
                        app.inProgress = false;
                    }
                })
                .catch(error => {
                    app.inProgress = false;
                    app.message = "Error checking status: " + error.message;
                    app.error = true;
                });
            };

            // Start the polling
            checkStatus();
        }
    </script>
</body>
</html>
